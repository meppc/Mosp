# 系统架构概览

本文档概述了基于Rust的跨平台白板软件的系统架构设计。该架构旨在提供高性能、跨平台和可扩展的白板协作体验。

## 架构设计原则

- **模块化设计**: 系统由多个松耦合模块组成，便于独立开发和测试
- **跨平台抽象**: 核心逻辑与平台特定实现分离
- **性能优先**: 关键路径优化以确保响应速度和渲染流畅性
- **安全可靠**: 充分利用Rust的内存安全特性
- **可扩展性**: 设计支持将来功能扩展和自定义插件

## 系统总体架构

白板软件系统由以下主要模块组成：

```
┌─────────────────────────────────────────────────────────┐
│                     应用层(Application)                 │
├─────────────┬─────────────────┬────────────┬────────────┤
│  工具箱     │    画布管理     │  文档处理  │  用户界面  │
│ (Toolbox)   │ (Canvas Manager)│(Documents) │   (UI)     │
├─────────────┴─────────────────┴────────────┴────────────┤
│                     核心层(Core)                        │
├─────────────┬─────────────────┬────────────┬────────────┤
│ 图形渲染    │     输入处理    │ 协作同步   │ 数据存储   │
│(Rendering)  │  (Input Handler)│(Collab.)   │ (Storage)  │
├─────────────┴─────────────────┴────────────┴────────────┤
│                    平台抽象层(Platform)                 │
├─────────────┬─────────────────┬────────────┬────────────┤
│   Windows   │     macOS       │  iPadOS    │  Android   │
│   适配器    │     适配器      │   适配器   │   适配器   │
└─────────────┴─────────────────┴────────────┴────────────┘
```

## 核心模块简介

### 图形渲染子系统

负责高性能、矢量化的图形绘制，利用Slint框架实现跨平台渲染与UI展示。详见[图形渲染子系统](./rendering-system.md)文档。

### 输入处理模块

处理多种输入设备的事件，包括鼠标、触控和压感笔，提供统一的抽象接口。支持手势识别和笔迹平滑处理。详见[输入处理模块](./input-processing.md)文档。

### 协作同步引擎

实现实时多用户协作，基于CRDT算法确保数据一致性，支持离线编辑和冲突解决。详见[协作同步引擎](./collaboration-engine.md)文档。

### 数据存储模块

负责白板状态的持久化、历史版本管理和高效查询，采用混合存储策略优化性能。详见[数据存储模块](./data-storage.md)文档。

## 应用层组件

### 工具箱

提供各类绘图工具、形状库和交互功能，包括选择、绘制、编辑等操作。

### 画布管理

处理画布状态、图层管理、缩放平移等视图操作，维护对象之间的空间关系。

### 文档处理

负责文档的创建、导入导出、版本控制和模板管理。

### 用户界面

基于Slint实现的跨平台UI系统，提供一致的用户体验和交互模式。

## 模块间通信

系统采用事件驱动架构，模块间通过以下方式通信：

1. **事件总线**: 核心组件通过中心化事件总线传递消息
2. **响应式状态**: 基于观察者模式的UI状态同步机制
3. **命令模式**: 用户操作被封装为可撤销/重做的命令对象
4. **异步通道**: 使用tokio通道实现异步组件间通信

## 扩展机制

系统设计了以下扩展点：

1. **插件系统**: 支持第三方工具和功能扩展
2. **自定义渲染器**: 允许实现专用渲染效果
3. **数据转换器**: 支持多种文件格式的导入导出

通过这种模块化架构，系统可以在保持核心稳定的同时灵活应对不同平台需求和功能扩展。